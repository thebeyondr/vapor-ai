---
phase: 06-deployments
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/(dashboard)/deployments/page.tsx
  - app/(dashboard)/deployments/components/deployments-table.tsx
  - app/(dashboard)/deployments/components/deployment-columns.tsx
  - app/(dashboard)/deployments/components/deployment-status-badge.tsx
  - app/(dashboard)/deployments/[id]/page.tsx
  - app/(dashboard)/deployments/[id]/components/inference-stats.tsx
  - app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a table of deployed models with model name, version, status, and creation date"
    - "User can sort deployments table by model name, request volume, latency, and deployment date"
    - "User can filter deployments table by model name search and status"
    - "Each deployed model displays inference stats: request volume, P50/P95 latency, error rate"
    - "Dashboard deployment count reflects actual deployment records"
  artifacts:
    - path: "app/(dashboard)/deployments/page.tsx"
      provides: "Deployments list page with data fetching"
      contains: "getAllDeployments"
    - path: "app/(dashboard)/deployments/components/deployments-table.tsx"
      provides: "TanStack Table with sorting and filtering"
      contains: "useReactTable"
    - path: "app/(dashboard)/deployments/components/deployment-columns.tsx"
      provides: "Column definitions for deployments table"
      contains: "ColumnDef"
    - path: "app/(dashboard)/deployments/components/deployment-status-badge.tsx"
      provides: "Color-coded deployment status badges"
      contains: "DeploymentStatusBadge"
    - path: "app/(dashboard)/deployments/[id]/page.tsx"
      provides: "Deployment detail page with inference metrics"
      contains: "getDeployment"
    - path: "app/(dashboard)/deployments/[id]/components/inference-stats.tsx"
      provides: "Inference metrics display cards"
      contains: "InferenceStats"
  key_links:
    - from: "app/(dashboard)/deployments/page.tsx"
      to: "lib/db/queries.ts"
      via: "Server Component data fetch"
      pattern: "getAllDeployments"
    - from: "app/(dashboard)/deployments/components/deployments-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable"
    - from: "app/(dashboard)/deployments/[id]/page.tsx"
      to: "lib/services/inference-simulator.ts"
      via: "Metrics generation"
      pattern: "generateInferenceMetrics"
    - from: "app/(dashboard)/deployments/components/deployment-columns.tsx"
      to: "app/(dashboard)/deployments/components/deployment-status-badge.tsx"
      via: "Status column cell renderer"
      pattern: "DeploymentStatusBadge"
---

<objective>
Build the deployments table page with TanStack Table (sorting + filtering) and the deployment detail page with inference stats cards.

Purpose: Complete the deployments dashboard, giving users visibility into their deployed models with realistic inference metrics — the final piece of the ML lifecycle story.
Output: Deployments page with interactive data table, deployment detail page with inference stats, updated dashboard counts.
</objective>

<execution_context>
@/home/wraith/.claude/get-shit-done/workflows/execute-plan.md
@/home/wraith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deployments/06-RESEARCH.md
@.planning/phases/06-deployments/06-01-SUMMARY.md
@lib/db/schema.ts
@lib/db/queries.ts
@lib/services/inference-simulator.ts
@app/(dashboard)/deployments/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build deployments table page with TanStack Table, sorting, and filtering</name>
  <files>
    app/(dashboard)/deployments/page.tsx
    app/(dashboard)/deployments/components/deployments-table.tsx
    app/(dashboard)/deployments/components/deployment-columns.tsx
    app/(dashboard)/deployments/components/deployment-status-badge.tsx
  </files>
  <action>
  **1. Create `DeploymentStatusBadge` component at `app/(dashboard)/deployments/components/deployment-status-badge.tsx`:**
  Follow Pattern 5 from research:
  - Status config map: deploying (blue, Rocket), active (green, CheckCircle), paused (amber, Pause), failed (red, XCircle)
  - Use ShadCN Badge with outline variant + custom className for each status color
  - WCAG accessible: color + icon + text label (matching project's existing StatusBadge pattern)

  **2. Create column definitions at `app/(dashboard)/deployments/components/deployment-columns.tsx`:**
  Follow the research code example closely:
  - Define `DeploymentRow` interface: id, modelName, version, status, createdAt, requestVolume, p95Latency, errorRate
  - Export `deploymentColumns: ColumnDef<DeploymentRow>[]` with columns:
    - **Model Name**: Sortable header (ArrowUpDown icon), cell renders as link to `/deployments/{id}` with `font-medium hover:underline`
    - **Version**: Plain text, mono font (`font-mono text-sm`)
    - **Status**: Renders `DeploymentStatusBadge`, with `filterFn` for multi-value filtering
    - **Req/sec**: Sortable, shows `volume.toFixed(1)` or dash for zero, custom sortingFn for null safety
    - **P95 Latency**: Sortable, shows `{latency}ms` or dash for zero
    - **Error Rate**: Shows `{rate}%`, red color if > 1%
    - **Deployed**: Sortable, uses `formatDistanceToNow` from date-fns with `{ addSuffix: true }`, custom sortingFn comparing timestamps

  **3. Create `DeploymentsTable` at `app/(dashboard)/deployments/components/deployments-table.tsx`:**
  "use client" component with TanStack Table:
  - Props: `data: DeploymentRow[]`, `columns` imported from deployment-columns
  - State: `sorting: SortingState`, `columnFilters: ColumnFiltersState`
  - Hook: `useReactTable` with `getCoreRowModel`, `getSortedRowModel`, `getFilteredRowModel`
  - UI layout (top to bottom):
    - Filter bar in a flex row:
      - `Input` component: placeholder "Filter by model name...", filters `modelName` column
      - `Select` component (ShadCN): Status filter with options "All", "Active", "Deploying", "Paused", "Failed"
    - ShadCN `Table` rendering from TanStack table model:
      - `TableHeader` → `table.getHeaderGroups()` → render headers with `flexRender`
      - `TableBody` → `table.getRowModel().rows` → render cells with `flexRender`
      - Empty state: Show "No deployments found" message with link to training jobs when `rows.length === 0`
    - Import `flexRender` from `@tanstack/react-table` for rendering headers and cells
  - **IMPORTANT Tailwind v4 note:** Audit any ShadCN table component for `[--var]` patterns and convert to `(--var)` syntax

  **4. Update deployments page at `app/(dashboard)/deployments/page.tsx`:**
  Server Component that:
  - Fetches all deployments via `getAllDeployments()` from queries.ts
  - Generates inference metrics for each deployment using `generateInferenceMetrics()`
  - Maps deployments + metrics into `DeploymentRow[]` format
  - Renders page header ("Deployments" title, subtitle "Monitor deployed models and inference performance")
  - Renders `DeploymentsTable` with the combined data
  - Shows empty state if no deployments (centered text + CTA button linking to `/training/jobs`)
  </action>
  <verify>
  - `pnpm build` passes with no TypeScript errors
  - Navigate to `/deployments` — page loads without errors
  - Table renders with correct columns when deployments exist
  - Sorting works on Model Name, Req/sec, P95 Latency, Deployed columns (click header toggles asc/desc)
  - Model name filter input filters table rows in real-time
  - Status dropdown filters by deployment status
  - Empty state shows helpful message when no deployments exist
  </verify>
  <done>
  Deployments page shows an interactive data table with all deployed models. Users can sort by any sortable column and filter by model name text search and status dropdown. Empty state guides users to create deployments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build deployment detail page with inference stats and update dashboard</name>
  <files>
    app/(dashboard)/deployments/[id]/page.tsx
    app/(dashboard)/deployments/[id]/components/inference-stats.tsx
    app/(dashboard)/page.tsx
  </files>
  <action>
  **1. Create `InferenceStats` component at `app/(dashboard)/deployments/[id]/components/inference-stats.tsx`:**
  "use client" component following the research Pattern (inference-stats.tsx):
  - Props: `metrics: InferenceMetrics` (import type from inference-simulator)
  - Render 4 metric cards in a responsive grid (`grid gap-4 md:grid-cols-2 lg:grid-cols-4`):
    - **Request Volume**: Activity icon, value `{volume.toFixed(1)} req/sec` or "No traffic", description "Current request rate"
    - **P50 Latency**: Zap icon, value `{p50}ms`, amber color if > 200ms, description "Median response time"
    - **P95 Latency**: TrendingUp icon, value `{p95}ms`, red color if > 500ms, description "95th percentile (SLA target)"
    - **Error Rate**: AlertCircle icon, value `{rate}%`, red if > 1% else green, description shows success rate
  - Use ShadCN Card/CardHeader/CardTitle/CardContent for each metric

  **2. Create deployment detail page at `app/(dashboard)/deployments/[id]/page.tsx`:**
  Server Component:
  - Parse `id` from params (Next.js 16 async params pattern — `const { id } = await params`)
  - Fetch deployment via `getDeployment(Number(id))` — redirect to `/deployments` if not found (use `notFound()` from next/navigation)
  - Generate inference metrics via `generateInferenceMetrics(deployment)`
  - Fetch the source training job via `getTrainingJob(deployment.jobId)` for context
  - Page layout:
    - Back link: "Back to Deployments" with ArrowLeft icon linking to `/deployments`
    - Header section: Model name (h1), version badge (mono font), status badge (`DeploymentStatusBadge`)
    - Deployment info card: Grid showing Endpoint (mono), Source Job (link to `/training/jobs/{jobId}`), Deployed date (formatted with date-fns `format`), Status
    - Inference Stats section: `<InferenceStats metrics={metrics} />` — only show if status is "active"
    - For non-active deployments, show a muted message "Metrics unavailable — deployment is {status}"

  **3. Update dashboard page** (`app/(dashboard)/page.tsx`):
  - Import `getDeploymentCounts` from queries.ts
  - Add deployed models count to the existing metrics cards (currently shows Active Jobs, Completed, Failed, Total)
  - Add a "Deployed Models" card showing the count of active deployments
  - This should integrate naturally into the existing `Promise.all` pattern for parallel data fetching
  </action>
  <verify>
  - `pnpm build` passes
  - Navigate to `/deployments/{id}` — detail page renders with deployment info and inference stats
  - Inference stats cards show realistic values (P50 < P95 < P99, error rate < 5%)
  - Non-active deployments show "metrics unavailable" message instead of stats
  - "Back to Deployments" link works
  - Source training job link navigates correctly
  - Dashboard shows deployed models count
  - `notFound()` triggers for invalid deployment IDs
  </verify>
  <done>
  Deployment detail page shows full deployment information with 4 inference metric cards (request volume, P50 latency, P95 latency, error rate). Dashboard includes deployed models count. Non-active deployments gracefully hide metrics.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no TypeScript errors
2. Deployments page (`/deployments`) shows interactive table with sorting and filtering
3. Model name search filter works in real-time
4. Status dropdown filter works (All/Active/Deploying/Paused/Failed)
5. Clicking model name navigates to deployment detail page
6. Deployment detail page shows inference stats for active deployments
7. Dashboard page shows deployed models count
8. Empty state on deployments page links to training jobs
9. Full deploy-to-view flow works: deploy job -> see in table -> click to detail -> see stats
</verification>

<success_criteria>
- Deployments table renders all deployed models with sortable/filterable columns
- Each deployment shows realistic inference metrics (request volume, latency percentiles, error rate)
- Deployment detail page provides full visibility into a single deployment
- Dashboard reflects deployment counts
- The complete ML lifecycle is navigable: discover -> configure -> train -> deploy -> monitor
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployments/06-02-SUMMARY.md`
</output>
