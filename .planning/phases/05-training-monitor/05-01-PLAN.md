---
phase: 05-training-monitor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - lib/services/training-simulator.ts
  - lib/hooks/use-interval.ts
  - package.json
  - components/ui/progress.tsx
autonomous: true

must_haves:
  truths:
    - "TrainingMetrics table exists in database with foreign key to trainingJobs"
    - "TrainingSimulator generates exponential decay loss curves with diminishing noise"
    - "useInterval hook provides declarative polling with cleanup and pause support"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "trainingMetrics table definition with index"
      contains: "trainingMetrics"
    - path: "lib/services/training-simulator.ts"
      provides: "TrainingSimulator class with generateLossPoint and generateAccuracy"
      exports: ["TrainingSimulator"]
    - path: "lib/hooks/use-interval.ts"
      provides: "useInterval custom hook"
      exports: ["useInterval"]
    - path: "components/ui/progress.tsx"
      provides: "ShadCN Progress component"
  key_links:
    - from: "lib/db/schema.ts"
      to: "trainingJobs"
      via: "foreign key reference"
      pattern: "references.*trainingJobs"
---

<objective>
Install dependencies (recharts, sonner, date-fns, ShadCN progress), add trainingMetrics schema table, create TrainingSimulator service, and build useInterval hook.

Purpose: Foundation layer for all training monitor features â€” schema for persistence, simulator for realistic curves, hook for polling, and UI deps for visualization.
Output: Database table, simulation service, polling hook, and all dependencies installed.
</objective>

<execution_context>
@/home/wraith/.claude/get-shit-done/workflows/execute-plan.md
@/home/wraith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-training-monitor/05-RESEARCH.md
@lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add trainingMetrics schema</name>
  <files>package.json, lib/db/schema.ts, components/ui/progress.tsx</files>
  <action>
    1. Install runtime dependencies: `pnpm add recharts sonner date-fns`
    2. Add ShadCN progress component: `npx shadcn@latest add progress` (use --yes flag if prompted)
    3. Verify ShadCN badge and card already installed (they should be from prior phases)

    4. Update `lib/db/schema.ts` to add trainingMetrics table:
       - Import `index` from `drizzle-orm/pg-core`
       - Add `trainingMetrics` pgTable with columns:
         - id: serial primary key
         - jobId: integer, notNull, references trainingJobs.id with onDelete cascade
         - epoch: integer, notNull
         - step: integer, notNull
         - loss: real, notNull
         - accuracy: real (nullable)
         - learningRate: real (nullable)
         - createdAt: timestamp, defaultNow, notNull
       - Add index on jobId: `trainingMetricsJobIdIdx` using index() on trainingMetrics.jobId
       - Export both the table and the index

    5. Push schema to database: `pnpm db:push`

    Note: Use the existing import pattern from schema.ts. Import `index` alongside the existing pgTable, serial, text, etc.
  </action>
  <verify>
    - `pnpm build` compiles without errors
    - `pnpm db:push` succeeds (schema synced to Neon)
    - `components/ui/progress.tsx` exists
    - `lib/db/schema.ts` exports `trainingMetrics`
  </verify>
  <done>
    - trainingMetrics table exists in Neon database with foreign key to training_jobs
    - recharts, sonner, date-fns are in package.json dependencies
    - ShadCN progress component is installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TrainingSimulator service and useInterval hook</name>
  <files>lib/services/training-simulator.ts, lib/hooks/use-interval.ts</files>
  <action>
    1. Create `lib/services/training-simulator.ts`:
       - Export `TrainingSimulator` class with configurable parameters:
         - initialLoss (default 2.5), finalLoss (default 0.3), decayRate (default 0.15)
       - Constructor accepts optional overrides: `{ initialLoss?, finalLoss?, decayRate? }`
       - `generateLossPoint(step: number, totalSteps: number): number`
         - Exponential decay: `finalLoss + (initialLoss - finalLoss) * exp(-decayRate * step)`
         - Add diminishing Gaussian noise: `noiseScale = 0.1 * (1 - progress * 0.8)` where `progress = step / totalSteps`
         - Floor at 0.05 to prevent negative values
       - `generateAccuracy(loss: number): number`
         - Inverse relationship: `1 - (loss / initialLoss)` with small noise (0.02 range)
         - Clamp between 0 and 1
       - `generateMetricsBatch(startStep: number, count: number, totalSteps: number, stepsPerEpoch: number): Array<{ epoch, step, loss, accuracy }>`
         - Generates `count` sequential metric points starting from `startStep`
         - Each point has epoch calculated as `Math.floor(step / stepsPerEpoch) + 1`

    2. Create `lib/hooks/use-interval.ts`:
       - Export `useInterval(callback: () => void, delay: number | null): void`
       - Based on Dan Abramov's pattern (referenced in research)
       - Use useRef to store latest callback
       - useEffect to update ref when callback changes
       - useEffect with setInterval that reads from ref
       - When delay is null, interval is paused (no setInterval created)
       - Return cleanup function from useEffect to clear interval on unmount
       - Mark with `"use client"` directive since it uses React hooks

    Note: These are pure utility files with no external dependencies beyond React. They should be fully self-contained.
  </action>
  <verify>
    - `pnpm build` compiles without errors
    - `lib/services/training-simulator.ts` exists and exports TrainingSimulator
    - `lib/hooks/use-interval.ts` exists and exports useInterval
    - TrainingSimulator.generateLossPoint returns values that decrease over time (manual inspection)
  </verify>
  <done>
    - TrainingSimulator generates realistic exponential decay loss curves with noise
    - useInterval hook provides declarative interval management with pause/cleanup
    - Both modules compile and are ready for consumption by monitor components
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with no errors
2. `lib/db/schema.ts` exports trainingMetrics with jobId foreign key
3. `lib/services/training-simulator.ts` exports TrainingSimulator class
4. `lib/hooks/use-interval.ts` exports useInterval hook
5. `components/ui/progress.tsx` exists (ShadCN component)
6. recharts, sonner, date-fns in package.json
</verification>

<success_criteria>
All foundation pieces for the training monitor are in place: schema table for metrics persistence, simulator for realistic curves, polling hook for real-time updates, and all required dependencies installed.
</success_criteria>

<output>
After completion, create `.planning/phases/05-training-monitor/05-01-SUMMARY.md`
</output>
