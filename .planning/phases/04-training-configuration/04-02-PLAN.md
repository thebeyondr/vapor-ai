---
phase: 04-training-configuration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(dashboard)/training/configure/page.tsx
  - app/(dashboard)/training/configure/actions.ts
  - app/(dashboard)/training/components/training-config-form.tsx
  - app/(dashboard)/training/components/model-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate from model discovery to training config page"
    - "User can select a base model from LFM catalog or search results"
    - "User can configure hyperparameters with inline validation"
    - "Form shows meaningful error messages for invalid inputs"
    - "User can submit form to create a training job persisted in Neon"
  artifacts:
    - path: "app/(dashboard)/training/configure/page.tsx"
      provides: "Training configuration page"
      min_lines: 15
    - path: "app/(dashboard)/training/configure/actions.ts"
      provides: "createTrainingJob Server Action"
      exports: ["createTrainingJob"]
    - path: "app/(dashboard)/training/components/training-config-form.tsx"
      provides: "Client-side training config form with RHF + Zod"
      min_lines: 80
  key_links:
    - from: "app/(dashboard)/training/components/training-config-form.tsx"
      to: "lib/validations/training-job.ts"
      via: "zodResolver import"
      pattern: "zodResolver.*trainingJobSchema"
    - from: "app/(dashboard)/training/components/training-config-form.tsx"
      to: "app/(dashboard)/training/configure/actions.ts"
      via: "Server Action call on submit"
      pattern: "createTrainingJob"
    - from: "app/(dashboard)/training/configure/actions.ts"
      to: "lib/db/schema.ts"
      via: "Drizzle insert"
      pattern: "db\\.insert\\(trainingJobs\\)"
    - from: "app/(dashboard)/training/components/model-card.tsx"
      to: "app/(dashboard)/training/configure/page.tsx"
      via: "Configure Training link with modelId query param"
      pattern: "configure\\?model="
---

<objective>
Build the training configuration form with model selection, hyperparameter inputs, inline validation, Server Action submission, and database persistence. Wire model cards to link to the config page.

Purpose: Core Phase 4 deliverable — user can configure and submit a training job with validated inputs.
Output: Complete /training/configure route with form, validation, submission, and DB persistence.
</objective>

<execution_context>
@/home/wraith/.claude/get-shit-done/workflows/execute-plan.md
@/home/wraith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-training-configuration/04-RESEARCH.md
@.planning/phases/04-training-configuration/04-01-SUMMARY.md
@lib/db/schema.ts
@lib/validations/training-job.ts
@app/(dashboard)/training/page.tsx
@app/(dashboard)/training/components/model-card.tsx
@lib/huggingface/liquid-lfm.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action and config page route</name>
  <files>app/(dashboard)/training/configure/actions.ts, app/(dashboard)/training/configure/page.tsx</files>
  <action>
1. Create `app/(dashboard)/training/configure/actions.ts`:
   - "use server" directive
   - `createTrainingJob(input: TrainingJobInput)` function
   - Server-side Zod validation using `trainingJobSchema.safeParse(input)` (defense in depth)
   - Error-as-data pattern: return `{ success: true, jobId: number }` or `{ success: false, error: string }`
   - Insert into DB: `db.insert(trainingJobs).values({...}).returning({ id: trainingJobs.id })`
   - Map form fields to DB columns: `modelId` -> `modelName`, etc.
   - Call `revalidatePath("/")` and `revalidatePath("/training")` after successful insert to invalidate dashboard and training caches
   - Do NOT use redirect() in Server Action — return jobId for client-side navigation (per research Pitfall 3)
   - Export the response type: `type CreateJobResponse = { success: true; jobId: number } | { success: false; error: string }`

2. Create `app/(dashboard)/training/configure/page.tsx`:
   - Server Component page
   - Accept `searchParams` prop with optional `model` query param (for pre-selected model)
   - Page header: "Configure Training Job" h1 with descriptive subtitle
   - Render `<TrainingConfigForm modelId={searchParams.model} />` wrapped in Suspense
   - Consistent styling with other pages (space-y-6 container)
  </action>
  <verify>
- `pnpm build` compiles (page route resolves, action is valid)
- File exists at `app/(dashboard)/training/configure/page.tsx`
- File exists at `app/(dashboard)/training/configure/actions.ts`
  </verify>
  <done>Server Action creates training job in database with validation, config page route renders at /training/configure</done>
</task>

<task type="auto">
  <name>Task 2: Build training config form and wire model card navigation</name>
  <files>app/(dashboard)/training/components/training-config-form.tsx, app/(dashboard)/training/components/model-card.tsx</files>
  <action>
1. Create `app/(dashboard)/training/components/training-config-form.tsx`:
   - "use client" directive
   - React Hook Form with `zodResolver(trainingJobSchema)`
   - Default values: name="", modelId=prop or "", learningRate=0.0002, epochs=3, batchSize=16
   - Props: `{ modelId?: string }` for pre-selection from model discovery

   Form fields (all using ShadCN Form components — FormField/FormItem/FormLabel/FormControl/FormDescription/FormMessage):
   a. **Job Name** — Input, placeholder "e.g., LFM-3B-finance-finetune"
   b. **Base Model** — Select dropdown populated with LIQUID_LFMS (import from `@/lib/huggingface/liquid-lfm`). Display model name + parameter count. If modelId prop provided, pre-select it.
   c. **Learning Rate** — Input type="number", step="0.000001", with FormDescription showing recommended range. Handle number coercion: `onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}` (per research Pitfall 1)
   d. **Epochs** — Input type="number", step="1", with FormDescription
   e. **Batch Size** — Select dropdown with power-of-2 options: 1, 2, 4, 8, 16, 32, 64, 128. FormDescription: "Number of samples per update step"

   Use `hyperparameterRanges` from validation module for FormDescription text (shows recommended values).

   Submission:
   - Call `createTrainingJob(data)` on form.handleSubmit
   - On success: `router.push("/")` (redirect to dashboard where they can see the new queued job)
   - On error: `form.setError("root", { message: result.error })` and show Alert at top of form
   - Submit button with loading state: "Creating..." when `form.formState.isSubmitting`, disabled during submission
   - Use `useTransition` for the server action call to get proper pending state

   Form-level error display:
   - If `form.formState.errors.root`, show ShadCN Alert with destructive variant and AlertCircle icon above the form

   Layout: Use Card component to wrap the form for visual containment. Max width ~2xl for readability.

2. Update `app/(dashboard)/training/components/model-card.tsx`:
   - Add a "Configure Training" button (or make the card clickable) that navigates to `/training/configure?model={model.id}`
   - Use `<Link>` from next/link for the button/link
   - Use ShadCN Button with variant="outline" and size="sm", placed in CardContent below the existing content
   - Add ArrowRight icon from lucide-react for visual affordance
  </action>
  <verify>
- `pnpm build` compiles without errors
- Navigate to `/training/configure` — form renders with all fields
- Navigate to `/training/configure?model=liquid/lfm-3b` — model pre-selected
- Submit form with valid data — job created in DB (check via `pnpm db:studio`)
- Submit form with invalid data — inline error messages appear
- Click "Configure Training" on model card — navigates to config page with model pre-selected
  </verify>
  <done>Training config form renders with all hyperparameter fields, validates inline with Zod, submits to create job in Neon DB, and model cards link to config page with pre-selection</done>
</task>

</tasks>

<verification>
1. Navigate to `/training` — model cards show "Configure Training" button
2. Click "Configure Training" on any model card — redirects to `/training/configure?model=...`
3. Config form shows pre-selected model, all hyperparameter fields with defaults
4. Clear the name field and submit — inline error "Name must be at least 3 characters"
5. Set learning rate to 5 and submit — inline error about max range
6. Fill valid data and submit — redirected to dashboard, new job appears with "queued" status
7. Check Neon DB — new training_jobs row with correct values including batch_size
</verification>

<success_criteria>
User can navigate from model discovery to training configuration, fill out validated hyperparameters, submit the form, and see the new training job persisted in the database. All 5 phase requirements (TRCF-01 through TRCF-05) are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/04-training-configuration/04-02-SUMMARY.md`
</output>
